Микросервис по получению сведений о геолокации по IP
====================================================

Микросерсис предсотавляет сведения геолокации по IP (IPv4 или IPv6), используя внешних поставщиков API.
Сервис позволяет выбрать одного из трёх предложенных поставщиков. Результат запроса кешируется на некоторое время.
На выбор доступно несколько систем кеширования.
На данном этапе эти сведения представляют из себя код страны.
Реализовано с использованием фреймворка Symfony 5.4.

Требования
----------

* PHP 7.4 или выше;
* Composer 2.0 и выше;
* Подклчюенное расширение PHP HTTP;
* Подклчюенное расширение PHP Memcached (в случае, если будет выбран метод кеширования с использованием Memcached);
* Подклчюенное расширение PHP APCu (в случае, если будет выбран метод кеширования с использованием APCu).

Установка
---------

Скопировать или склонировать проект по месту разворачивания.
Из корневого каталога проекта установить зависимости через composer.
```bash
$ composer install
```

Настройка микросервиса
----------------------

Все настройки расположены в файле .env и настроены таким образом, что-бы микросервис мог работать сразу
после разворачивания с минимальными требованиями к среде запуска.
Однако рекомендуется изменить метод кеширования исходя из возможностей среды.
Не рекомендуется изменять параметры в самом файле. Лучшим решением будет создать в том же каталоге файл .env.local,
скопировать в него содержимое файла .env и изменять настройки в файле .env.local.

Поставщики API
--------------

В качестве поставщиков API выступают нижеприведённые ресурсы. Список приведён в формате "ресурс (значение параметра IP_GEO_PROVIDER_NAME)":

* ip-api.com (ip-api). Ограничение поставщика - не более 45 запросов в минуту с одного IP-адреса.
* ipwhois.io (ipwhois). Ограничение поставщика - не более 10 000 запросов в месяц с одного IP-адреса.
* geoplugin.com (geoplugin). Ограничение поставщика - не более 120 запросов в минуту с одного IP-адреса. При превышении лимита включается бан по IP на час.

Кеширование
-----------

Т.к. практически все поставщики API ограничивают частоту запросов, сервис кеширует полученный ответ по конкретному 
IP-адресу на некоторое время, определяемое значением параметра IP_GEO_CACHE_LIFETIME в секундах.
По-умолчанию установлено 3600 секунд (1 час).

Поддерживаются нижеуказанные методы кеширования. Список приведён в формате "ресурс (значение параметра IP_GEO_CACHE_SYSTEM)":
* FileSystem (file). Стоит по-умолчанию. Используйте только в случае, если другие варианты кеширования вам не доступны.
* APCu (apcu). Для использования в системе должно быть установлено расширение PHP APCu. Лучший вариант, если недоступен вариант Memcached.
* Memcached (memcached). Рекомендуемое решение. Требуются установленный сервер Memcached и соответствующее расширение PHP Memcached.

В случае использования FileSystem требуется периодическая очистка от устаревших элементов.
Для этого нужно выполнить команду, находясь в корневом каталоге проекта:

```bash
php bin/console cache:pool:prune
```

В случае использования Memcached так же требуется установить следующие параметры:
* MEMCACHED_HOST - хост, на котором расположен сервер Memcached. По-умолчанию localhost.
* MEMCACHED_PORT - порт хоста, прослушиваемый сервером Memcached. По-умолчанию 11211.

Запуск
------

Если у вас нет установленного веб-сервера, то используйте команду от корня проекта
```bash
php -S localhost:8000 -t public/
```

И откройте в браузере  URL (<http://localhost:8000>)

В случае, если у вас установлен веб-сервер, то настройте его, указав в качестве каталога приложения каталог проекта /public.

Использование
-------------

Сервис работает по следующему шаблону запроса:

```http request
http//hostname/?ip={запрашиваемый IP}
```

где место {запрашиваемый IP} занимает конкретный IP-адрес.

Если запрос выполнен успешно, сервер отвечает со статусом 200 следующей структурой в формате JSON: 
```json
{
  "success":true,
  "response":
    {
      "countryCode":"countryCodeValue"
    }
}
```

В случае ошибки ответ состоит из одного поля
```json
{
  "success":false
}
```

Если ip-адрес небыл передан либо передан некорректный адрес, то ответ будет со статусом 400.
В случае других ошибок ответ будет со статусом 500.